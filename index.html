<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="main.css">
    <link type="text/css" src="./dist/bttn.min.css" />
</head>

<body>
    <!-- <body onload='loadpendingtodolist()'>-->
    <!--  <body onload='loadtodolist()'>
    <div class="flex-container">
        <p>
          <input id="new-task" type="text" class="newinput">
          <button id ="add-button" class="addbutton"><img src="add.svg" id = "addimage" class = "addimage"></button>
          <button onclick="location.href='https://assistant.google.com/services/a/uid/000000864377308f'" id ="assist-button" class="addbutton"><img src="assist.svg" id = "assistimage" class = "addimage"></button>
          <button id ="signout-button" class="signoutbutton" onclick="AppSignout()"><img src="signout.svg" id = "signoutimage" class = "signoutimage"></button>
        </p>
        <ul id="incomplete-tasks">
        </ul>
        <p>
        <button id ="show-complete-button" class="showcompletedbutton" onclick="loadcompletedtodolist()">Show Completed Tasks</button>
        </p>
        <ul id="completed-tasks">
        </ul>
        <p>
          <button id ="show-future-button" class="showcompletedbutton" onclick="loadfuturetodolist()">Show Future Tasks</button>
        </p>
        <ul id="future-tasks">
        </ul>
      </div>
-->
    <button onclick="authenticate().then(loadClient).then(execute)"><h1>Load Google Tasks</h1></button>

    <!-- Insert these scripts at the bottom of the HTML, but before you use any Firebase services -->
    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="firebase-app.js"></script>
    <!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
    <script src="firebase-analytics.js"></script>
    <!-- Add Firebase products that you want to use -->
    <script src="firebase-auth.js"></script>
    <script src="firebase-firestore.js"></script>
    <script src="chrono.min.js"></script>
    <!--<script type="text/javascript" src="app.js"></script>-->
    <script src="https://apis.google.com/js/api.js"></script>
    <script>

        ///google tasks api

        function authenticate() {
            return gapi.auth2.getAuthInstance()
                .signIn({ scope: "https://www.googleapis.com/auth/tasks.readonly" })
                .then(function () { console.log("Sign-in successful"); },
                    function (err) { console.error("Error signing in", err); });
        }
        function loadClient() {
            gapi.client.setApiKey("AIzaSyAQ--7BYrBnmjsdX8LvNIOu8uIE7alDsAE");
            return gapi.client.load("https://content.googleapis.com/discovery/v1/apis/tasks/v1/rest")
                .then(function () { console.log("GAPI client loaded for API"); },
                    function (err) { console.error("Error loading GAPI client for API", err); });
        }
        // Make sure the client is loaded and sign-in is complete before calling this method.
        function execute() {
            var tomorrow = new Date();

            // Subsequent queries will use persistence, if it was enabled successfully
            //Handle Account Status

            tomorrow.setDate(tomorrow.getDate() + 1);
            return gapi.client.tasks.tasks.list({
                "tasklist": "@default",
                "dueMax": tomorrow.toISOString(),
                "maxResults": 10000,
                "showCompleted": false,
                "showDeleted": false
            })
                .then(async function (response) {
                    // var gtasks = JSON.parse(response.result)
                    // Handle the results here (response.result has the parsed body).  
                    var config = {
                        apiKey: "AIzaSyAQ--7BYrBnmjsdX8LvNIOu8uIE7alDsAE",
                        authDomain: "listspeaker.firebaseapp.com",
                        databaseURL: "https://listspeaker.firebaseio.com",
                        projectId: "listspeaker",
                        storageBucket: "listspeaker.appspot.com",
                        messagingSenderId: "576657502351"
                    };
                    firebase.initializeApp(config);

                    var useremail = null;
                    var db;
                    await firebase.auth().onAuthStateChanged(user => {
                        if (user) {
                            useremail = user.email; console.log('logged in' + user.uid + ' email  ' + user.email);
                            db = firebase.firestore();
                        }
                        else {
                            console.log('NOT logged in');
                            window.location = 'signin.html';
                        }
                    });
                    await new Promise(r => setTimeout(r, 3000));

                   await db.collection("tasks").where("uemail", "==", useremail).get()
                        .then((querySnapshot) => {
                            querySnapshot.forEach((doc) => {
                                console.log('delete   - ' + doc.data().title + doc.data().dueDate);
                                db.collection("tasks").doc(doc.id).delete().then(function () {
                                    console.log("Document successfully deleted!");
                                }).catch(function (error) {
                                    console.error("Error removing document: ", error);
                                });
                            });
                        });

                   await new Promise(r => setTimeout(r, 5000));

                    console.log("Response", response);
                    var taskLists = response.result.items;
                    if (taskLists && taskLists.length > 0) {
                        for (var i = 0; i < taskLists.length; i++) {
                            var taskList = taskLists[i];
                            console.log(i + ' . ' + taskList.title);
                            if (useremail != null) {
                                console.log("if New Add task..." + i + ' . ' + taskList.title + '  - ' + useremail);
                                db.collection("tasks").add({
                                    uemail: useremail,
                                    title: taskList.title,
                                    dueDate: new Date(),
                                    dateAdded: new Date(),
                                    status: false
                                });
                            };

                        }
                    } else {
                        console.log('No task lists found.');
                    }
                },
                    function (err) { console.error("Execute error", err); });
        }
        gapi.load("client:auth2", function () {
            gapi.auth2.init({ client_id: "576657502351-qeak2lt68shslqidvrnbm2b12kjp21i1.apps.googleusercontent.com" });
        });
    </script>

</body>

</html>
